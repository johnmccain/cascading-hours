<?php

/*** CREATE FUNCTIONS ***/

/**
 * Save an entry in the database.
 *
 * @param string $table
 *   The table to insert into.
 *
 * @param array $entry
 *   An array containing all the fields of the database record.
 *
 * @see db_insert()
 */
function ch_entry_insert($table, $entry) {
  $return_value = null;
  try {
    $return_value = db_insert($table)
          ->fields($entry)
          ->execute();
  } catch (Exception $e) {
    drupal_set_message(t('db_insert failed. Message = %message, query= %query',
    array('%message' => $e->getMessage(), '%query' => $e->query_string)), 'error');
  }
  return $return_value;
}

/**
 * Create a location with name $name if one doesn't already exist
 *
 * @param string $name
 *   The name of the new location
 */
function ch_create_location($name) {
  $result = db_select('cascading_hours_locations')
            ->fields('name')
            ->condition('name', $name, '=')
            ->execute()
            ->fetchAssoc();
  if($result) {
    //Location with name $name already exists TODO: give some kind of feedback to user
    drupal_set_message(t('Tried to create location with name %name but one already exists.',
    array('%name' => $name)), 'error');
  } else {
    //Create location
    $entry['name'] = $name;
    ch_entry_insert('locations', $entry);
  }
}


/*** GET FUNCTIONS ***/

/**
 *
 */
function ch_get_schedule_in_range_for_location_with_name($location_name, $start_date, $end_date) {
  $location = db_select('cascading_hours_locations')
            ->fields('id', 'name')
            ->condition('name', $name, '=')
            ->execute()
            ->fetchAssoc();

  if($location['id']) {
    ch_get_schedule_in_range_for_location_with_id($location['id']);
  } else {
    return [];
  }
}

/**
 *
 *  @param int $location_id
 *  @param int $start_date - UNIX timestamp for start of date range
 *  @param int $end_date - UNIX timestamp for end of date range
 */
function ch_get_schedule_in_range_for_location_with_id($location_id, $start_date, $end_date) {
  $schedule = [];

  $rules = ch_get_rules_in_range_for_location_with_id($location_id, $start_date, $end_date);
  //TODO: create array of applicable schedules from an array of rules
}

/**
 *  Finds all rules for a location within a given range
 *  @param int $location_id
 *  @param int $start_date - UNIX timestamp for start of date range
 *  @param int $end_date - UNIX timestamp for end of date range
 *
 *  @return array - 2d array of rules and their fields, ordered by priority
 */
function ch_get_rules_in_range_for_location_with_id($location_id, $start_date, $end_date) {
  $rules = db_select('cascading_hours_rules', 'c')
            ->fields('c')
            ->condition('location_id', $location_id, '=')
            ->condition('start_date', date('YYYY-MM-DD HH:MM:SS', $start_date), '>')
            ->condition('end_date', date('YYYY-MM-DD HH:MM:SS', $end_date), '<')
            ->orderBy('priority', 'ASC')
            ->execute()
            ->fetchAssoc();
  return $rules;
}

/**
 * Returns an array of rules with the given location_id
 * @param int $location_id - the location_id to find matching rules for
 *
 * @return array - a 2d array of rules and their fields
 */
function ch_get_rules_with_location_id($location_id) {
  $rules = db_select('cascading_hours_rules', 'c')
            ->fields('c')
            ->condition('location_id', $location_id, '=')
            ->execute()
            ->fetchAssoc();

  return $rules;
}

/*** DELETE FUNCTIONS ***/

/**
 *  Deletes all locations with given name and all associated rules
 *
 *  @param string $name
 */
function ch_delete_location_with_name($name) {
  $location = db_select('cascading_hours_locations')
            ->fields('id', 'name')
            ->condition('name', $name, '=')
            ->execute()
            ->fetchAssoc();

  if($location['id']) {
    ch_delete_location_with_id($location['id']);
  }
}

/**
 *  Deletes all locations with given id and all associated rules
 *
 *  @param int $id
 */
function ch_delete_location_with_id($id) {
  ch_delete_rules_with_location_id($id);
  $result = db_delete('cascading_hours_locations')
            ->condition('id', $id, '=')
            ->execute();
}

/**
 *  Deletes all rules with given location_id and all associated schedules
 *
 *  @param int $location_id
 */
function ch_delete_rules_with_location_id($location_id) {
  $rules = ch_get_rules_with_location_id($location_id);

  //delete rules and all associated schedules
  foreach($rules as $rule) {
    ch_delete_rule_with_id($rule['id']);
  }
}

/**
 *  Deletes a rule with given id and all associated schedules
 *
 *  @param int $id
 */
function ch_delete_rule_with_id($id) {
  $result = db_delete('cascading_hours_rules')
            ->condition('id', $id, '=')
            ->execute();

  ch_delete_schedule_with_rule_id($id);
}

/**
 *  Deletes all schedules with given rule_id
 *
 *  @param int $rule_id
 */
function ch_delete_schedule_with_rule_id($rule_id) {
  $schedules = db_select('cascading_hours_schedules')
            ->fields('id', 'rule_id')
            ->condition('rule_id', $rule_id, '=')
            ->execute()
            ->fetchAssoc();

  //delete schedules
  foreach($schedules as $schedule) {
    ch_delete_rule_with_id($schedule['id']);
  }
}

/**
 *  Deletes a schedule with given id
 *
 *  @param int $id
 */
function ch_delete_schedule_with_id($id) {
  $result = db_delete('cascading_hours_schedules')
            ->condition('id', $id, '=')
            ->execute();
}
